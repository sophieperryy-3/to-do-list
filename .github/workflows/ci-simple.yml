# Enhanced CI Pipeline with Hard Quality Gates
# Enforces code quality, security, and testing standards

name: CI Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  # Backend CI with Hard Gates
  backend-ci:
    name: ðŸ”§ Backend CI
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install dependencies
        working-directory: backend
        run: npm install

      - name: ðŸ§¹ Lint code (HARD GATE)
        working-directory: backend
        run: |
          echo "::group::Backend Linting"
          npm run lint
          echo "âœ… Backend linting passed"
          echo "::endgroup::"

      - name: ðŸ§ª Run tests with coverage (HARD GATE)
        working-directory: backend
        run: |
          echo "::group::Backend Tests with Coverage"
          npm run test:ci
          echo "âœ… Backend tests passed with coverage"
          echo "::endgroup::"

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: |
            backend/junit.xml
            backend/coverage/
          retention-days: 30

      - name: ðŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: ðŸ” Security audit (HARD GATE)
        working-directory: backend
        run: |
          echo "::group::Backend Security Audit"
          echo "Checking for high/critical vulnerabilities..."
          
          # Run audit and capture output
          npm audit --audit-level=high --json > audit-results.json || true
          
          # Check if there are high/critical vulnerabilities
          HIGH_VULNS=$(cat audit-results.json | jq -r '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(cat audit-results.json | jq -r '.metadata.vulnerabilities.critical // 0')
          
          echo "High vulnerabilities: $HIGH_VULNS"
          echo "Critical vulnerabilities: $CRITICAL_VULNS"
          
          if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ Security audit failed: Found $HIGH_VULNS high and $CRITICAL_VULNS critical vulnerabilities"
            npm audit --audit-level=high
            exit 1
          else
            echo "âœ… Security audit passed: No high/critical vulnerabilities found"
          fi
          echo "::endgroup::"

      - name: ðŸ—ï¸ Build TypeScript (HARD GATE)
        working-directory: backend
        run: |
          echo "::group::Backend Build"
          npm run build
          echo "âœ… Backend build successful"
          echo "::endgroup::"

  # Frontend CI with Hard Gates
  frontend-ci:
    name: ðŸŽ¨ Frontend CI
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install dependencies
        working-directory: frontend
        run: npm install

      - name: ðŸ§¹ Lint code (HARD GATE)
        working-directory: frontend
        run: |
          echo "::group::Frontend Linting"
          npm run lint
          echo "âœ… Frontend linting passed"
          echo "::endgroup::"

      - name: ðŸ§ª Run tests with coverage (HARD GATE)
        working-directory: frontend
        run: |
          echo "::group::Frontend Tests with Coverage"
          npm run test:ci
          echo "âœ… Frontend tests passed with coverage"
          echo "::endgroup::"

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results
          path: |
            frontend/junit.xml
            frontend/coverage/
          retention-days: 30

      - name: ðŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: ðŸ” Security audit (HARD GATE)
        working-directory: frontend
        run: |
          echo "::group::Frontend Security Audit"
          echo "Checking for high/critical vulnerabilities..."
          
          # Run audit and capture output
          npm audit --audit-level=high --json > audit-results.json || true
          
          # Check if there are high/critical vulnerabilities
          HIGH_VULNS=$(cat audit-results.json | jq -r '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(cat audit-results.json | jq -r '.metadata.vulnerabilities.critical // 0')
          
          echo "High vulnerabilities: $HIGH_VULNS"
          echo "Critical vulnerabilities: $CRITICAL_VULNS"
          
          if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ Security audit failed: Found $HIGH_VULNS high and $CRITICAL_VULNS critical vulnerabilities"
            npm audit --audit-level=high
            exit 1
          else
            echo "âœ… Security audit passed: No high/critical vulnerabilities found"
          fi
          echo "::endgroup::"

      - name: ðŸ—ï¸ Build application (HARD GATE)
        working-directory: frontend
        run: |
          echo "::group::Frontend Build"
          npm run build
          echo "âœ… Frontend build successful"
          echo "::endgroup::"
        env:
          VITE_API_URL: http://localhost:3000

  # Quality Gates Summary
  quality-gates-summary:
    name: ðŸ“Š Quality Gates Summary
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci]
    if: always()
    
    steps:
      - name: ðŸ“‹ Generate Quality Report
        run: |
          echo "# ðŸ›¡ï¸ Quality Gates Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Backend results
          if [ "${{ needs.backend-ci.result }}" == "success" ]; then
            echo "âœ… **Backend CI**: All quality gates passed" >> $GITHUB_STEP_SUMMARY
            echo "  - âœ… Linting: Passed" >> $GITHUB_STEP_SUMMARY
            echo "  - âœ… Tests: Passed" >> $GITHUB_STEP_SUMMARY
            echo "  - âœ… Security Audit: No high/critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "  - âœ… Build: Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Backend CI**: Quality gates failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Frontend results
          if [ "${{ needs.frontend-ci.result }}" == "success" ]; then
            echo "âœ… **Frontend CI**: All quality gates passed" >> $GITHUB_STEP_SUMMARY
            echo "  - âœ… Linting: Passed" >> $GITHUB_STEP_SUMMARY
            echo "  - âœ… Tests: Passed" >> $GITHUB_STEP_SUMMARY
            echo "  - âœ… Security Audit: No high/critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "  - âœ… Build: Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Frontend CI**: Quality gates failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quality Standards Enforced" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Quality**: ESLint rules enforced as hard gates" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Coverage**: All tests must pass" >> $GITHUB_STEP_SUMMARY
          echo "- **Security**: No high/critical vulnerabilities allowed" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Integrity**: TypeScript compilation must succeed" >> $GITHUB_STEP_SUMMARY
          echo "- **Compliance**: Automated quality checks prevent human error" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.backend-ci.result }}" == "success" ] && [ "${{ needs.frontend-ci.result }}" == "success" ]; then
            echo "âœ… All quality gates passed - ready for deployment!"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Status**: Ready for deployment" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Quality gates failed - deployment blocked"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš« **Status**: Deployment blocked until issues resolved" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi