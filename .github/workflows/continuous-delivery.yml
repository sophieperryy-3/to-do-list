# Continuous Delivery Pipeline
# Reuses CI artifacts and deploys with manual approval

name: Continuous Delivery

on:
  push:
    branches: [staging, release/*]
  workflow_dispatch: # Allow manual trigger

env:
  AWS_REGION: us-east-1

jobs:
  # Manual approval gate
  approval:
    name: üîí Manual Approval
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: ‚è∏Ô∏è Waiting for approval
        run: |
          echo "================================"
          echo "‚è∏Ô∏è  MANUAL APPROVAL REQUIRED"
          echo "================================"
          echo "This is Continuous Delivery:"
          echo "- Code is built and tested automatically by CI"
          echo "- Deployment requires human approval"
          echo ""
          echo "Click 'Review deployments' to approve"

  # Deploy after approval (reuses CI artifacts)
  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: approval
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì• Download frontend artifact from CI
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üì§ Deploy to S3
        working-directory: frontend
        run: |
          aws s3 sync dist/ s3://todo-frontend-sophie-98633-381541067682/ --delete
          echo "‚úÖ Deployed to production!"

      - name: üéâ Deployment complete
        run: |
          echo "================================"
          echo "üéâ DEPLOYMENT SUCCESSFUL!"
          echo "================================"
          echo "‚úÖ Frontend deployed to S3"
          echo "‚úÖ Application available at CloudFront URL"
          echo ""
          echo "This demonstrates Continuous Delivery:"
          echo "- Automated CI/CD pipeline"
          echo "- Manual approval gate"
          echo "- Artifact reuse (no rebuild)"
          echo "- Production deployment"